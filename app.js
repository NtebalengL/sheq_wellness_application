const API_BASE = localStorage.getItem('SHEQ_API') || 'http://localhost:8000';const messagesDiv = document.getElementById('messages');const form = document.getElementById('form');const input = document.getElementById('input');const resourcesBtn = document.getElementById('resourcesBtn');const panel = document.getElementById('panel');const resourcesUl = document.getElementById('resources');const healthLink = document.getElementById('health');
function addMsg(text, who='bot'){const div=document.createElement('div');div.className='msg '+who;div.textContent=text;messagesDiv.appendChild(div);messagesDiv.scrollTop=messagesDiv.scrollHeight;}
addMsg('Hi! I can share general information about consent, contraception, safety and where to get help. Ask me anything.','bot');
form.addEventListener('submit', async (e)=>{e.preventDefault(); const text = input.value.trim(); if(!text) return; addMsg(text, 'user'); input.value=''; try{ const res = await fetch(API_BASE + '/api/ask', { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ text }) }); if(!res.ok) throw new Error('Request failed'); const data = await res.json(); addMsg(data.answer, 'bot'); if(data.escalate){ addMsg('We noticed this may be urgent. Please call: 0800 428 428 (GBV Command Centre) or 10111 if in danger.','bot'); } }catch(err){ addMsg('Sorry, could not reach server at ' + API_BASE, 'bot'); }});
resourcesBtn.addEventListener('click', async ()=>{ panel.classList.toggle('hidden'); if(!panel.classList.contains('hidden')){ resourcesUl.innerHTML='<li>Loading...</li>'; try{ const res = await fetch(API_BASE + '/api/resources'); const data=await res.json(); resourcesUl.innerHTML=''; data.resources.forEach(r=>{ const li=document.createElement('li'); li.innerHTML = '<strong>'+r.name+'</strong> â€” '+(r.phone||r.url||'') + (r.notes? ' <em>(' + r.notes + ')</em>' : ''); resourcesUl.appendChild(li); }); }catch{ resourcesUl.innerHTML='<li>Could not load resources.</li>'; } }});
healthLink.addEventListener('click', async (e)=>{ e.preventDefault(); try{ const res = await fetch(API_BASE + '/api/health'); const data = await res.json(); alert('Backend OK. Messages: ' + data.messages); }catch{ alert('Backend not reachable at ' + API_BASE); } });